<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学核心素养AI训练系统 - 完整集成版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: { enableMenu: false },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 1200px; height: 95vh; background: white; border-radius: 24px; box-shadow: 0 25px 75px rgba(0, 0, 0, 0.2); overflow: hidden; display: flex; flex-direction: column; }
        
        /* 头部 */
        .header { background: linear-gradient(90deg, #4a6bff 0%, #6c5ce7 100%); color: white; padding: 20px 35px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 1.8rem; display: flex; align-items: center; gap: 15px; }
        
        .main-content { flex: 1; display: flex; overflow: hidden; }
        
        /* 侧边栏：11种素养 */
        .sidebar { width: 300px; background: #f8f9ff; border-right: 1px solid #eaeaea; padding: 20px; overflow-y: auto; flex-shrink: 0; }
        .sidebar h3 { color: #4a6bff; margin-bottom: 15px; font-size: 1.1rem; }
        .competency-item { 
            padding: 12px; margin-bottom: 8px; background: white; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 10px;
        }
        .competency-item:hover { transform: translateX(5px); }
        .competency-item.active { border-left-color: #4a6bff; background: #eef2ff; }
        .competency-icon { width: 35px; height: 35px; border-radius: 50%; background: #4a6bff; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
        .competency-info h4 { font-size: 0.95rem; color: #333; }

        /* 聊天区 */
        .chat-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-container { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; background: #fdfdff; }
        .message { display: flex; max-width: 85%; animation: fadeIn 0.3s; }
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .message-content { padding: 15px 20px; border-radius: 18px; line-height: 1.6; font-size: 1rem; }
        .user-message .message-content { background: #4a6bff; color: white; border-bottom-right-radius: 2px; }
        .ai-message .message-content { background: white; color: #333; border: 1px solid #e1e8f0; border-bottom-left-radius: 2px; }

        /* 公式实时预览 */
        #mathPreview {
            display: none; position: absolute; bottom: 100px; left: 20px; right: 20px;
            padding: 15px; background: white; border: 2px solid #4a6bff; border-radius: 12px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100;
        }
        
        .input-container { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
        #userInput { flex: 1; padding: 15px 20px; border: 2px solid #e1e8f0; border-radius: 30px; outline: none; font-size: 1rem; }
        #sendButton { background: #4a6bff; color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: 0.2s; }
        #sendButton:hover { transform: scale(1.1); background: #3a56d4; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-microchip"></i> 数学核心素养训练系统</h1>
            </div>
            <div id="currentTag" style="background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:15px; font-size:0.9rem;">
                当前：数感
            </div>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <h3>11大核心素养</h3>
                <ul id="competencyList"></ul>
            </div>
            
            <div class="chat-area">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <div class="message-content">
                            你好！我是龚凤乾教授设计的AI中学（含高中）数学辅导app。请在左侧选择想要训练的<b>核心素养</b>，并在下方输入数学问题。<br>支持输入 LaTeX 公式，例如：<code>$\frac{a}{b}$</code>。
                        </div>
                    </div>
                </div>

                <div id="mathPreview"></div>
                
                <div class="input-container">
                    <input type="text" id="userInput" placeholder="输入问题或公式..." autocomplete="off">
                    <button id="sendButton"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

<script>
// 完整11种核心素养数据
const competencies = [
    { id: 1, title: "数感", icon: "fa-sort-numeric-up" },
    { id: 2, title: "量感", icon: "fa-weight-hanging" },
    { id: 3, title: "抽象能力", icon: "fa-cube" },
    { id: 4, title: "几何直观", icon: "fa-draw-polygon" },
    { id: 5, title: "空间观念", icon: "fa-vector-square" },
    { id: 6, title: "创新意识", icon: "fa-lightbulb" },
    { id: 7, title: "运算能力", icon: "fa-calculator" },
    { id: 8, title: "推理能力", icon: "fa-project-diagram" },
    { id: 9, title: "数据观念", icon: "fa-chart-bar" },
    { id: 10, title: "模型观念", icon: "fa-sitemap" },
    { id: 11, title: "应用意识", icon: "fa-rocket" }
];

let currentComp = "数感";
const DEEPSEEK_API_KEY = "sk-b6c7f4dfb8224b3c934e1370f81d9c3f";

// 初始化侧边栏
const listEl = document.getElementById('competencyList');
competencies.forEach(comp => {
    const li = document.createElement('li');
    li.className = `competency-item ${comp.title === currentComp ? 'active' : ''}`;
    li.innerHTML = `
        <div class="competency-icon"><i class="fas ${comp.icon}"></i></div>
        <div class="competency-info"><h4>${comp.title}</h4></div>
    `;
    li.onclick = () => {
        document.querySelectorAll('.competency-item').forEach(el => el.classList.remove('active'));
        li.classList.add('active');
        currentComp = comp.title;
        document.getElementById('currentTag').innerText = "当前：" + currentComp;
    };
    listEl.appendChild(li);
});

// 公式预览逻辑
const userInput = document.getElementById('userInput');
const mathPreview = document.getElementById('mathPreview');

userInput.addEventListener('input', () => {
    const val = userInput.value;
    if (val.includes('$')) {
        mathPreview.style.display = 'block';
        mathPreview.innerHTML = "<small style='color:#4a6bff'>预览渲染：</small><br>" + val;
        MathJax.typesetPromise([mathPreview]);
    } else {
        mathPreview.style.display = 'none';
    }
});

function addMessage(text, sender) {
    const chat = document.getElementById('chatContainer');
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${sender}-message`;
    msgDiv.innerHTML = `<div class="message-content">${text.replace(/\n/g, '<br>')}</div>`;
    chat.appendChild(msgDiv);
    
    MathJax.typesetPromise([msgDiv]).then(() => {
        chat.scrollTop = chat.scrollHeight;
    });
}

async function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;

    addMessage(text, 'user');
    userInput.value = '';
    mathPreview.style.display = 'none';

   try {
    // 1. 请求地址改为相对路径
    const res = await fetch("/.netlify/functions/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // 2. 这里就是你要找的 body，只传必要的参数
        body: JSON.stringify({ 
            currentComp: currentComp, 
            text: text 
        })
    });

    const data = await res.json();
    
    // 3. 注意：后端返回的数据结构可能略有不同，取决于你在 chat.js 里的 return
    if (data.choices && data.choices[0]) {
        addMessage(data.choices[0].message.content, 'ai');
    } else {
        throw new Error("AI 响应异常");
    }

} catch (e) {
    console.error("出错了：", e);
    addMessage("系统繁忙，请稍后再试。", 'ai');
}
        });
        const data = await res.json();
        addMessage(data.choices[0].message.content, 'ai');
    } catch (e) {
        addMessage("系统繁忙，请稍后再试。", "ai");
    }
}

document.getElementById('sendButton').onclick = handleSend;
userInput.onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
</script>
</body>
</html>